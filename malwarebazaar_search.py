import os
from dotenv import load_dotenv
from colorama import Fore, Style
import hashtrail

load_dotenv()

def search_malbazaar(hash256):
    api_key = os.getenv("MALBAZAAR_API_KEY")
    if not api_key:
        print(f"{Fore.RED}[✗] MalwareBazaar API key missing")
        return

    url = "https://mb-api.abuse.ch/api/v1/"
    headers = {'Auth-Key': api_key}
    data = {"query": "get_info", "hash": hash256}

    bazaar_info = hashtrail.req_post(url, headers, data)
    parse_malbazaar(bazaar_info)

def parse_malbazaar(bazaar_info):
    status = bazaar_info.get('query_status')
    
    if status != "ok":
        if status == "unknown_auth_key":
            print(f"{Fore.RED}[✗] Incorrect API key")
        else:
            print(f"{Fore.YELLOW}[!] Status of the request : {status}")
        return

    try:
        entry = bazaar_info['data'][0]
    except (IndexError, KeyError, TypeError) as e:
        print(f"{Fore.YELLOW}[!] No Malware Bazaar info available. Error: {e}")
        return

    tags = entry.get('tags', [])
    info = {
        "SHA256": entry.get('sha256_hash', 'N/A'),
        "File Name": entry.get('file_name', 'N/A'),
        "File Type MIME": entry.get('file_type_mime', 'N/A'),
        "File Type": entry.get('file_type', 'N/A'),
        "First Seen": entry.get('first_seen', 'N/A'),
        "Signature": entry.get('signature', 'N/A'),
        "Tags": ", ".join(tags),
        "MalwareBazaar Link": f"https://bazaar.abuse.ch/sample/{entry.get('sha256_hash')}/",
    }
    hashtrail.print_info(info)

    print(f"\n{Fore.CYAN}- ANY.RUN -{Style.RESET_ALL}\n")

    anyrun_data = entry.get('vendor_intel', {}).get('ANY.RUN')
    if isinstance(anyrun_data, list) and anyrun_data:
        first_entry = anyrun_data[0]
        info_anyrun = {
            "Malware Family": first_entry.get('malware_family', 'N/A'),
            "Verdict": first_entry.get('verdict', 'N/A'),
            "Analysis URL": first_entry.get('analysis_url', 'N/A'),
        }
        hashtrail.print_info(info_anyrun)
    else:
        print(f"{Fore.YELLOW}[!] No ANY.RUN info available.")
